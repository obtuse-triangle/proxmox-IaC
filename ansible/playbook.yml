# playbook.yml (예시)

# ---
# PLAY 1: Proxmox 호스트를 설정하여 LXC 옵션을 수정
- name: "Configure Proxmox LXC settings for k3s"
  hosts: proxmox_hosts # 로컬에서 Proxmox 호스트로 SSH 접속
  gather_facts: false
  vars:
    ansible_ssh_extra_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

  
  tasks:
    - name: "Ensure cgroup2 device rule exists for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.cgroup2.devices.allow: c 1:11 rwm"
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"
    
    - name: "Ensure kmsg mount entry exists for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.mount.entry: /dev/kmsg dev/kmsg none bind,create=file"
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"

    - name: "Ensure apparmor profile is unconfined for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.apparmor.profile: unconfined"
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"
    
    - name: "Ensure cgroup devices allow all for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.cgroup.devices.allow: a"
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"
    
    - name: "Ensure capabilities drop is empty for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.cap.drop:"
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"
    
    - name: "Ensure mount auto for proc and sys for LXC nodes"
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ hostvars[item].vmid }}.conf"
        line: "lxc.mount.auto: \"proc:rw sys:rw\""
        state: present
      delegate_to: "{{ hostvars[item].node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "item"
        label: "{{ item }}"
    
    - name: "Restart LXC containers to apply changes"
      ansible.builtin.command: "pct reboot {{ item.vmid }}"
      delegate_to: "{{ item.node }}"
      loop: "{{ query('inventory_hostnames', 'k3s_cluster') }}"
      loop_control:
        loop_var: "hostname"
        label: "{{ hostname }}"
      vars:
        item: "{{ hostvars[hostname] }}"

# ---
# PLAY 2: k3s 클러스터 설치 (기존 플레이북과 동일)
- import_playbook: k3s.orchestration.site